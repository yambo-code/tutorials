#!/bin/bash
#PBS -l walltime=01:40:00
#PBS -l select=1:ncpus=16:mpiprocs=16:mem=30Gb     
#PBS -o job.out
#PBS -e job.err
#PBS -q parallel 
#PBS -A IscrC_2DQCONF  

module load profile/base autoload/0.1 intel/cs-xe-2013--binary intelmpi/4.1.1--binary mkl/11.0.1--binary gnu/4.6.3 cuda/5.0.35 qe/5.0.3 netcdf/4.1.3--intel--cs-xe-2013--binary hdf5/1.8.9_ser--intel--cs-xe-2013--binary szip/2.1--gnu--4.6.3 zlib/1.2.7--gnu--4.6.3 blas lapack
module unload qe/5.0.3

TMPDIR='./tmp-29k'
PSEUDO_DIR='/gpfs/scratch/userexternal/mpalummo/D_mau/D_pseudo/PWSCF'
BIN_DIR='/eurora/home/userexternal/mpalummo/D_sources/qe5.1_bin'
cd /gpfs/scratch/userexternal/mpalummo/D_mau/D_runs/D_GaSb/D_nSO

cat > gasb.scf.in  << EOF
 &control
    title = 'GaSb bulk'
    calculation = 'scf'
    verbosity='high',
    prefix='gasb_bulk',
    pseudo_dir = '$PSEUDO_DIR',
    outdir='$TMPDIR'
    etot_conv_thr=1.0e-4,
    forc_conv_thr=1.0e-3,
    disk_io='high',
    wf_collect=.true.
 /
 &system    
      ibrav=2, 
      celldm(1)=11.388,
      nat=2, 
      ntyp=2,
      ecutwfc =18.0, 
 /
 &electrons
    mixing_beta = 0.6 
    conv_thr =  1.0d-8,
 /
ATOMIC_SPECIES
 Ga   69.72   Garel.TMSOFTER.UPF
 Sb  121.75   Sbrel.TMSOFTER.UPF
ATOMIC_POSITIONS
Ga      0.00 0.00 0.00
Sb      0.25 0.25 0.25                                                          
K_POINTS {automatic}
4 4 4 1 1 1
EOF
#
$BIN_DIR/pw.x < gasb.scf.in > gasb.scf.out 
cat > gasb.nscf.in.29k  << EOF
 &control
    title = 'GaSb bulk'
    calculation = 'nscf'
    verbosity='high',
    prefix='gasb_bulk',
    pseudo_dir = '$PSEUDO_DIR',
    outdir='$TMPDIR'
    etot_conv_thr=1.0e-4,
    forc_conv_thr=1.0e-3,
    disk_io='high',
    wf_collect=.true.
 /
 &system 
      ibrav=2, 
      celldm(1)=11.388,
      nat=2, 
      ntyp=2,
      ecutwfc =18.0, 
      nbnd=100,
 /
 &electrons
   diago_thr_init=5.0e-6,
   diago_full_acc=.true.
   electron_maxstep = 200,
   mixing_beta = 0.6
   conv_thr =  1.0d-9,
 /
ATOMIC_SPECIES
 Ga   69.72   Garel.TMSOFTER.UPF
 Sb  121.75   Sbrel.TMSOFTER.UPF
ATOMIC_POSITIONS
Ga      0.00 0.00 0.00
Sb      0.25 0.25 0.25
K_POINTS {crystal}
29
-0.1250000 -0.2500000 0.0000000 1
-0.1250000 -0.5000000 0.0000000 1
-0.2500000 -0.3750000 0.0000000 1
-0.1250000 -0.3750000 0.1250000 1
-0.1250000 0.2500000 0.0000000 1
-0.2500000 0.3750000 0.0000000 1
-0.3750001 -0.5000000 0.0000000 1
-0.2500001 -0.5000000 0.1250000 1
-0.1250000 0.0000000 0.0000000 1
-0.3750000 0.0000000 0.0000000 1
-0.3750000 -0.5000000 -0.1250000 1
0.1250000 -0.1250000 0.0000000 1
0.1250000 -0.2500000 0.1250000 1
0.0000000 -0.2500000 0.2500000 1
-0.2500000 -0.5000000 0.0000000 1
0.1250000 0.0000000 0.1250000 1
-0.3750000 -0.3750000 0.0000000 1
0.0000000 -0.3750000 0.1250000 1
-0.3750000 -0.2500000 -0.1250000 1
-0.2500000 -0.2500000 -0.2500000 1
0.3750000 0.2500000 0.6250000 1
0.3750000 -0.3750000 0.0000000 1
0.3750000 -0.2500000 -0.1250000 1
-0.5000000 -0.6250000 -0.1250000 1
-0.5000000 -0.5000000 0.0000000 1
-0.2500000 -0.5000000 0.2500000 1
-0.2500000 0.0000000 -0.2500000 1
-0.5000000 -0.5000000 -0.5000000 1
0.0000000 0.0000000 0.0000000 1
EOF
#
$BIN_DIR/pw.x <gasb.nscf.in.29k > gasb.nscf.out.29k
done
